name: Semantic Versioning Enforcement

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  pull_request:
    types: [opened, edited, synchronize]
  pull_request_target:
    types: [opened, edited, synchronize]

jobs:
  enforce-semantic-versioning:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate PR title semantic versioning
        id: validate-title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "Checking PR title: '$PR_TITLE'"
          
          # Check if title has semantic versioning prefix
          if [[ "$PR_TITLE" =~ ^(Release v[0-9]+\.[0-9]+\.[0-9]+|feat|fix|docs|style|refactor|test|chore)(\(.+\))?: ]]; then
            echo "✅ PR title has valid semantic versioning prefix"
            echo "compliant=true" >> $GITHUB_OUTPUT
          else
            echo "❌ PR title lacks semantic versioning prefix"
            echo "compliant=false" >> $GITHUB_OUTPUT
            
            # Suggest appropriate prefix
            if [[ "$PR_TITLE" =~ [Cc]hangelog|[Ww]orkflow ]]; then
              SUGGESTED="Release v1.0.0: $PR_TITLE"
            elif [[ "$PR_TITLE" =~ [Aa]dd|[Nn]ew|[Ff]eature|[Ee]nhance ]]; then
              SUGGESTED="feat: $PR_TITLE"
            elif [[ "$PR_TITLE" =~ [Ff]ix|[Bb]ug ]]; then
              SUGGESTED="fix: $PR_TITLE"
            else
              SUGGESTED="chore: $PR_TITLE"
            fi
            
            echo "suggested=$SUGGESTED" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR with semantic versioning guidance
        if: steps.validate-title.outputs.compliant == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const suggested = "${{ steps.validate-title.outputs.suggested }}";
            const body = `## 🏷️ Semantic Versioning Required
            
            This PR title needs a semantic versioning prefix to comply with the changelog workflow requirements.
            
            **Current title:** \`${{ github.event.pull_request.title }}\`
            **Suggested title:** \`${suggested}\`
            
            ### Valid prefixes:
            - \`Release v1.0.0:\` - for releases and major workflow changes
            - \`feat:\` - new features  
            - \`fix:\` - bug fixes
            - \`docs:\` - documentation changes
            - \`style:\` - formatting/style changes
            - \`refactor:\` - code refactoring
            - \`test:\` - test changes
            - \`chore:\` - maintenance tasks
            
            Please update your PR title to include an appropriate semantic versioning prefix.
            
            _This comment was generated automatically by the semantic versioning enforcement workflow._`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Log enforcement action to diagnostics
        run: |
          mkdir -p .github/diagnostics
          echo "" >> .github/diagnostics/changelog-ci.log
          echo "## [$(date -u '+%Y-%m-%d %H:%M:%S')] Event: semantic_versioning_check" >> .github/diagnostics/changelog-ci.log
          echo "- **Action:** Validated PR #${{ github.event.pull_request.number }} title for semantic versioning compliance" >> .github/diagnostics/changelog-ci.log
          echo "- **Rationale:** Ensure all PRs follow semantic versioning for changelog automation and release management" >> .github/diagnostics/changelog-ci.log
          echo "- **Role/Expertise:** Autonomous Project Owner, Lead Developer" >> .github/diagnostics/changelog-ci.log
          echo "- **References:** scripts/pr-title-validator.sh, protocols/changelog-maintenance-process.md" >> .github/diagnostics/changelog-ci.log
          echo "- **Impact:** PR title compliance: ${{ steps.validate-title.outputs.compliant }}, Title: '${{ github.event.pull_request.title }}'" >> .github/diagnostics/changelog-ci.log